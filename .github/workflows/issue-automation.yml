name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

jobs:
  issue-triage:
    name: Issue Triage and Labeling
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Get issue data
        id: issue-data
        run: |
          echo "title=$(echo '${{ github.event.issue.title }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "body=$(echo '${{ github.event.issue.body }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          
      - name: Add needs-triage label
        uses: actions/github-script@v7
        with:
          script: |
            const { issue_number } = process.env;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['needs-triage']
            });
        env:
          issue_number: ${{ steps.issue-data.outputs.issue_number }}
          
      - name: Determine category labels
        id: category-labels
        run: |
          title="${{ steps.issue-data.outputs.title }}"
          category_labels=""
          
          if [[ $title == *"bug"* ]]; then
            category_labels="bug"
          elif [[ $title == *"epic"* ]]; then
            category_labels="epic"
          elif [[ $title == *"maintenance"* ]]; then
            category_labels="maintenance"
          fi
          
          if [ -n "$category_labels" ]; then
            echo "category_labels=$category_labels" >> $GITHUB_OUTPUT
          fi
          
      - name: Determine priority labels
        id: priority-labels
        run: |
          title="${{ steps.issue-data.outputs.title }}"
          body="${{ steps.issue-data.outputs.body }}"
          priority_label="priority-medium"
          
          # Check for critical priority keywords
          if [[ $title == *"critical"* ]] || [[ $body == *"critical"* ]] || \
             [[ $title == *"urgent"* ]] || [[ $body == *"urgent"* ]] || \
             [[ $title == *"production"* ]] || [[ $body == *"production"* ]] || \
             [[ $title == *"outage"* ]] || [[ $body == *"outage"* ]]; then
            priority_label="priority-critical"
          # Check for high priority keywords
          elif [[ $title == *"important"* ]] || [[ $body == *"important"* ]] || \
               [[ $title == *"high"* ]] || [[ $body == *"high"* ]] || \
               [[ $title == *"blocking"* ]] || [[ $body == *"blocking"* ]]; then
            priority_label="priority-high"
          # Check for low priority keywords
          elif [[ $title == *"low"* ]] || [[ $body == *"low"* ]] || \
               [[ $title == *"nice-to-have"* ]] || [[ $body == *"nice-to-have"* ]] || \
               [[ $title == *"minor"* ]] || [[ $body == *"minor"* ]]; then
            priority_label="priority-low"
          fi
          
          echo "priority_label=$priority_label" >> $GITHUB_OUTPUT
          
      - name: Add category labels
        if: steps.category-labels.outputs.category_labels != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { issue_number, category_labels } = process.env;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: category_labels.split(',')
            });
        env:
          issue_number: ${{ steps.issue-data.outputs.issue_number }}
          category_labels: ${{ steps.category-labels.outputs.category_labels }}
          
      - name: Add priority labels
        uses: actions/github-script@v7
        with:
          script: |
            const { issue_number, priority_label } = process.env;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: [priority_label]
            });
        env:
          issue_number: ${{ steps.issue-data.outputs.issue_number }}
          priority_label: ${{ steps.priority-labels.outputs.priority_label }}
          
      - name: Check if first-time contributor
        id: check-first-time
        uses: actions/github-script@v7
        with:
          script: |
            const author = '${{ steps.issue-data.outputs.author }}';
            const repo = context.repo;
            
            // Search for previous issues by this author
            const searchResult = await github.rest.search.issuesAndPullRequests({
              q: `repo:${repo.owner}/${repo.repo} author:${author} type:issue`
            });
            
            const isFirstTime = searchResult.data.total_count <= 1;
            console.log(`Is first time contributor: ${isFirstTime}`);
            console.log(`Total issues found: ${searchResult.data.total_count}`);
            
            return isFirstTime;
            
      - name: Add first-time-contributor label
        if: steps.check-first-time.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { issue_number } = process.env;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              labels: ['first-time-contributor']
            });
        env:
          issue_number: ${{ steps.issue-data.outputs.issue_number }}

  task-breakdown:
    name: Epic Task Breakdown
    runs-on: ubuntu-latest
    needs: issue-triage
    if: |
      github.event.action == 'opened' && 
      contains(github.event.issue.title, 'Epic') || 
      contains(github.event.issue.title, 'epic')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create sub-issues for epic
        id: create-sub-issues
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            
            const taskNames = [
              "Requirements Analysis",
              "Design and Architecture", 
              "Implementation",
              "Testing and Documentation"
            ];
            
            const subIssueNumbers = [];
            
            for (let i = 0; i < 4; i++) {
              const subIssueTitle = `[SUBTASK] ${issue.title} - Task ${i + 1}: ${taskNames[i]}`;
              const subIssueBody = `This is a sub-task for the epic #${issue.number}\n\n**Related to #${issue.number}**\n\nThis task focuses on: ${taskNames[i]}`;
              
              const subIssue = await github.rest.issues.create({
                owner: repo.owner,
                repo: repo.repo,
                title: subIssueTitle,
                body: subIssueBody,
                labels: ['enhancement', 'needs-review']
              });
              
              subIssueNumbers.push(subIssue.data.number);
              console.log(`Created sub-issue #${subIssue.data.number}: ${subIssueTitle}`);
            }
            
            return subIssueNumbers;
            
      - name: Update parent issue with epic tasks
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            const subIssueNumbers = ${{ steps.create-sub-issues.outputs.result }};
            
            const epicTasksSection = `## Epic Tasks\n\n` +
              subIssueNumbers.map((num, index) => {
                const taskNames = [
                  "Requirements Analysis",
                  "Design and Architecture", 
                  "Implementation",
                  "Testing and Documentation"
                ];
                return `- [ ] #${num} - ${taskNames[index]}`;
              }).join('\n');
            
            // Get current issue body
            const currentIssue = await github.rest.issues.get({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number
            });
            
            const currentBody = currentIssue.data.body || '';
            const updatedBody = currentBody + '\n\n' + epicTasksSection;
            
            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number,
              body: updatedBody
            });
            
            console.log(`Updated parent issue #${issue.number} with epic tasks section`);

  auto-response:
    name: Auto Response and Milestone Assignment
    runs-on: ubuntu-latest
    needs: [issue-triage, task-breakdown]
    if: github.event.action == 'opened'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Get issue labels
        id: get-labels
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            
            const issueData = await github.rest.issues.get({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number
            });
            
            const labels = issueData.data.labels.map(label => label.name);
            console.log(`Issue #${issue.number} labels: ${labels.join(', ')}`);
            
            return labels;
            
      - name: Post appropriate response
        id: post-response
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            const labels = ${{ steps.get-labels.outputs.result }};
            
            let response = '';
            
            if (labels.includes('bug')) {
              response = `## Bug Report Guidelines\n\n` +
                `Thank you for reporting this bug! Please ensure you've included:\n` +
                `1. Steps to reproduce the issue\n` +
                `2. Expected vs actual behavior\n` +
                `3. Environment details (OS, browser, version)\n` +
                `4. Any relevant screenshots or logs\n\n` +
                `Our team will investigate this issue shortly.`;
            } else if (labels.includes('epic')) {
              response = `## Feature Request Process\n\n` +
                `Thank you for submitting this epic feature request! This has been broken down into 4 sub-tasks:\n` +
                `1. Requirements Analysis\n` +
                `2. Design and Architecture\n` +
                `3. Implementation\n` +
                `4. Testing and Documentation\n\n` +
                `Each sub-task will be tracked separately and linked back to this epic.`;
            } else if (labels.includes('maintenance')) {
              response = `## Maintenance Guidelines\n\n` +
                `Thank you for reporting this maintenance task! Please ensure you've included:\n` +
                `1. Type of maintenance needed\n` +
                `2. Current state and proposed changes\n` +
                `3. Impact assessment (performance, risk, testing)\n` +
                `4. Any related issues or PRs\n\n` +
                `Maintenance tasks are scheduled based on priority and available resources.`;
            } else {
              response = `## Issue Received\n\n` +
                `Thank you for submitting this issue! Our team will review it shortly.\n\n` +
                `**Next Steps:**\n` +
                `1. The issue has been labeled and triaged\n` +
                `2. It will be reviewed by our maintainers\n` +
                `3. You'll receive updates on any progress or questions`;
            }
            
            // Add welcome message for first-time contributors
            if (labels.includes('first-time-contributor')) {
              response = `ðŸ‘‹ **Welcome to the project!**\n\n` +
                `Thank you for submitting your first issue to this repository!\n\n` +
                response;
            }
            
            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number,
              body: response
            });
            
            console.log(`Posted response to issue #${issue.number}`);
            
      - name: Set milestone for high priority issues
        if: |
          contains(fromJson(steps.get-labels.outputs.result), 'priority-high') ||
          contains(fromJson(steps.get-labels.outputs.result), 'priority-critical')
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            
            // First, check if milestone exists
            let milestone;
            try {
              const milestones = await github.rest.issues.listMilestones({
                owner: repo.owner,
                repo: repo.repo,
                state: 'open'
              });
              
              milestone = milestones.data.find(m => m.title === 'v1.0.0');
              
              if (!milestone) {
                // Create milestone if it doesn't exist
                milestone = await github.rest.issues.createMilestone({
                  owner: repo.owner,
                  repo: repo.repo,
                  title: 'v1.0.0',
                  description: 'Version 1.0.0 release milestone'
                });
              }
            } catch (error) {
              console.log('Error finding/creating milestone:', error.message);
              return;
            }
            
            // Update issue with milestone
            await github.rest.issues.update({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number,
              milestone: milestone.number
            });
            
            console.log(`Set milestone v1.0.0 for issue #${issue.number}`);
            
      - name: Update status from needs-triage to needs-review
        uses: actions/github-script@v7
        with:
          script: |
            const { issue } = context.payload;
            const repo = context.repo;
            
            // Remove needs-triage label
            try {
              await github.rest.issues.removeLabel({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: issue.number,
                name: 'needs-triage'
              });
            } catch (error) {
              console.log('Error removing needs-triage label:', error.message);
            }
            
            // Add needs-review label
            await github.rest.issues.addLabels({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: issue.number,
              labels: ['needs-review']
            });
            
            console.log(`Updated issue #${issue.number} from needs-triage to needs-review`);